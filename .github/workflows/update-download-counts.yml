name: Update Download Counts

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡

jobs:
  update-counts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Download current download-counts.json
        run: |
          # ä» GitHub è·å–å½“å‰çš„ä¸‹è½½æ¬¡æ•°
          curl -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/ruanhaodong-tt/ruanhaodong-tt.github.io/contents/download-counts.json \
            | jq -r '.content' | base64 -d > download-counts.json
      
      - name: Fetch and count downloads from Issues
        run: |
          # è·å– Issue #1 çš„æ‰€æœ‰è¯„è®º
          curl -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/ruanhaodong-tt/ruanhaodong-tt.github.io/issues/1/comments \
            | jq -r '.[] | .body' > comments.txt
          
          # ç»Ÿè®¡æ¯ä¸ªæ–‡ä»¶çš„ä¸‹è½½æ¬¡æ•°
          node << 'EOF'
          const fs = require('fs');
          const comments = fs.readFileSync('comments.txt', 'utf8');
          const counts = JSON.parse(fs.readFileSync('download-counts.json', 'utf8'));
          
          // è§£æè¯„è®ºå¹¶ç»Ÿè®¡
          const lines = comments.split('\n');
          lines.forEach(line => {
            const match = line.match(/ğŸ“¥ ä¸‹è½½è®°å½•: (.+)/);
            if (match) {
              const filename = match[1];
              if (counts[filename] !== undefined) {
                counts[filename]++;
              }
            }
          });
          
          // ä¿å­˜æ›´æ–°åçš„è®¡æ•°
          fs.writeFileSync('download-counts.json', JSON.stringify(counts, null, 2));
          console.log('ä¸‹è½½æ¬¡æ•°å·²æ›´æ–°');
          EOF
      
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add download-counts.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Auto update download counts from Issues [skip ci]"
          git push